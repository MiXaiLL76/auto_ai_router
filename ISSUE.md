# OpenAI API Router - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI-–ø–æ–¥–æ–±–Ω—ã–º API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –ª–∏–º–∏—Ç–æ–≤.

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- **–Ø–∑—ã–∫**: Go (–¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞—Ç–∏–≤–Ω–æ–π –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏)
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: YAML
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –ë–µ–∑ –ë–î, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ —Ñ–∞–π–ª–∞

## –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞
```
User ‚Üí HTTP Request ‚Üí Router ‚Üí Token Substitution ‚Üí Round-Robin Credential Selection ‚Üí Upstream API ‚Üí Response ‚Üí User
```

### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ credentials

#### –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (config.yaml)
```yaml
server:
  port: 8080                    # –ü–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  max_body_size_mb: 100         # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä request body
  request_timeout: 30s          # –¢–∞–π–º–∞—É—Ç –¥–ª—è upstream –∑–∞–ø—Ä–æ—Å–æ–≤
  logging_level: info           # –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: info, debug, error (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é info)
  replace_v1_models: true       # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–æ–¥–µ–ª–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–æ–¥–µ–ª—è–º
  master_key: "sk-master-xxx"   # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
  default_models_rpm: 50        # RPM –ª–∏–º–∏—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –º–æ–¥–µ–ª–µ–π (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ models.yaml)

fail2ban:
  max_attempts: 3               # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–æ –±–∞–Ω–∞
  ban_duration: permanent       # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–∞ (permanent - –Ω–∞–≤—Å–µ–≥–¥–∞)
  error_codes: [401, 403, 429, 500, 502, 503, 504]  # –ö–æ–¥—ã, —Å—á–∏—Ç–∞—é—â–∏–µ—Å—è –æ—à–∏–±–∫–∞–º–∏ (–≤—Å—ë –∫—Ä–æ–º–µ 200)

credentials:
  - name: "provider_1"
    type: "openai"
    api_key: "sk-xxxx"
    base_url: "https://api.openai.com"
    rpm: 60                     # Requests Per Minute –ª–∏–º–∏—Ç

  - name: "provider_2"
    type: "openai"
    api_key: "sk-yyyy"
    base_url: "https://api.custom-provider.com"
    rpm: 120

monitoring:
  prometheus_enabled: true
  health_check_path: "/health"
```

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—ã–±–æ—Ä–∞ credentials
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: Round-robin —Å —É—á–µ—Ç–æ–º RPM –ª–∏–º–∏—Ç–æ–≤ (credential + model) –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π
- **–õ–æ–≥–∏–∫–∞**:
  1. –ü–µ—Ä–µ–±–æ—Ä credentials –ø–æ –∫—Ä—É–≥—É
  2. –ü—Ä–æ–ø—É—Å–∫ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö credentials (fail2ban)
  3. –ü—Ä–æ–ø—É—Å–∫ credentials, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–µ–≤—ã—à–µ–Ω RPM –ª–∏–º–∏—Ç
  4. –ü—Ä–æ–≤–µ—Ä–∫–∞ RPM –ª–∏–º–∏—Ç–∞ –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å —É–∫–∞–∑–∞–Ω–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ)
  5. –ü—Ä–æ–ø—É—Å–∫ credentials, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ `replace_v1_models: true`)
  6. –ï—Å–ª–∏ –≤—Å–µ credentials –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ model RPM exceeded ‚Üí –≤–æ–∑–≤—Ä–∞—Ç 503 Service Unavailable

### 3. Rate Limiting (RPM –∫–æ–Ω—Ç—Ä–æ–ª—å)

#### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤
–†–æ—É—Ç–µ—Ä —Ä–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:

**1. Credential-level RPM** (–Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞):
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `credentials[].rpm` –≤ `config.yaml`
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—Å–∞–º —á–µ—Ä–µ–∑ –¥–∞–Ω–Ω—ã–π credential
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç sliding window –∞–ª–≥–æ—Ä–∏—Ç–º

**2. Model-level RPM** (–Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥–µ–ª–∏):
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `models.yaml`
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –∑–∞–ø—Ä–æ—Å–∞–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç credential
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –¥–æ—Ä–æ–≥–∏–µ –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GPT-4)

#### –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è **–æ–±–∞** –ª–∏–º–∏—Ç–∞:
```
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ credential RPM ‚Üí ‚úì OK
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ model RPM ‚Üí ‚úì OK
3. –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω
```

–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω ‚Üí –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è (503 Service Unavailable)

#### –§–∞–π–ª models.yaml
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–æ–¥–µ–ª–µ–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –æ—Ç credentials:

```yaml
models:
  - name: gpt-4o
    rpm: 50  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –¥–æ—Ä–æ–≥–æ–π –º–æ–¥–µ–ª–∏

  - name: gpt-4o-mini
    rpm: 100  # –ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è –¥–µ—à–µ–≤–æ–π –º–æ–¥–µ–ª–∏

  - name: gpt-3.5-turbo
    rpm: 150
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ**:
- **–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ**: –†–æ—É—Ç–µ—Ä —á–∏—Ç–∞–µ—Ç `models.yaml` (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- **–ü–æ—Å–ª–µ fetching –º–æ–¥–µ–ª–µ–π**: –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ —Å `default_models_rpm` –∏–∑ config.yaml
- **–†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å RPM –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ—É—Ç–µ—Ä

**–ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –≤ models.yaml**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `default_models_rpm` –∏–∑ `config.yaml`

### 4. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤

#### Master Key
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä**: `master_key` –≤ —Å–µ–∫—Ü–∏–∏ `server`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ï–¥–∏–Ω—ã–π –∫–ª—é—á –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –æ–±—Ä–∞—â–∞—é—â–∏—Ö—Å—è –∫ —Ä–æ—É—Ç–µ—Ä—É
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –†–æ—É—Ç–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `Authorization: Bearer <master_key>` –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- **–ü–æ–¥–º–µ–Ω–∞**: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ—É—Ç–µ—Ä –∑–∞–º–µ–Ω—è–µ—Ç `master_key` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π `api_key` –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ credential
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
  - –ï—Å–ª–∏ `master_key` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí 401 Unauthorized
  - –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí 401 Unauthorized
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –∫–ª—é—á–æ–º (–º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ –ø–µ—Ä–≤—ã—Ö 7 —Å–∏–º–≤–æ–ª–æ–≤)

#### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```python
from openai import OpenAI

client = OpenAI(
    api_key="sk-your-master-key",  # –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –∏–∑ config.yaml
    base_url="http://localhost:8080/v1"
)
```

–†–æ—É—Ç–µ—Ä –∑–∞–º–µ–Ω–∏—Ç `sk-your-master-key` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API –∫–ª—é—á –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏–∑ `credentials`.

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

#### Endpoints
- **–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã**: –ü–µ—Ä–µ—Ö–≤–∞—Ç –≤—Å–µ—Ö `/v1/*` endpoints
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ endpoints**:
  - `/v1/chat/completions` - –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –º–æ–¥–µ–ª–∏
  - `/v1/completions` - –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –º–æ–¥–µ–ª–∏
  - `/v1/embeddings` - –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –º–æ–¥–µ–ª–∏
  - `/v1/models` (GET) - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –æ—Ç –≤—Å–µ—Ö credentials (–µ—Å–ª–∏ `replace_v1_models: true`)
  - `/v1/*` (–ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ endpoints)

#### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: –ü—Ä–æ–≤–µ—Ä–∫–∞ `Authorization: Bearer <master_key>` –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ `server.master_key`
2. **Bearer Token**: –ü–æ–¥–º–µ–Ω–∞ `Authorization: Bearer <master_key>` –Ω–∞ `Authorization: Bearer <selected_credential_api_key>`
3. **Base URL**: –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ `base_url` –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ credential
4. **Request Body** (JSON):
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `model` –¥–ª—è model-aware routing
   - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–¥–º–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ JSON body **–∑–∞–ª–æ–∂–µ–Ω**, –Ω–æ –ø–æ–∫–∞ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª–µ–π –≤ –±—É–¥—É—â–µ–º

#### Streaming –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Server-Sent Events (SSE) –¥–ª—è streaming –æ—Ç–≤–µ—Ç–æ–≤
- –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ streaming –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç upstream –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏

### 4. Fail2Ban –º–µ—Ö–∞–Ω–∏–∑–º

#### –£—Å–ª–æ–≤–∏—è –±–∞–Ω–∞
- **–¢—Ä–∏–≥–≥–µ—Ä**: –õ—é–±–æ–π HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞ != 200 —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π
- **–ü–æ—Ä–æ–≥**: 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥—Ä—è–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
- **–†–∞–∑–±–∞–Ω**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–∞–Ω –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω (–∏–ª–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫/—Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ)

#### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
- –°—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ credential
- –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—à–∏–±–∫–∏
- –°—Ç–∞—Ç—É—Å –±–∞–Ω–∞ (–∞–∫—Ç–∏–≤–µ–Ω/–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω)

### 6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

#### Prometheus –º–µ—Ç—Ä–∏–∫–∏
- `auto_ai_router_requests_total{credential, endpoint, status}` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- `auto_ai_router_requests_duration_seconds{credential, endpoint}` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- `auto_ai_router_credential_rpm_current{credential}` - —Ç–µ–∫—É—â–∏–π RPM –ø–æ –∫–∞–∂–¥–æ–º—É credential
- `auto_ai_router_credential_banned{credential}` - —Å—Ç–∞—Ç—É—Å –±–∞–Ω–∞ (1 - –∑–∞–±–∞–Ω–µ–Ω, 0 - –∞–∫—Ç–∏–≤–µ–Ω)
- `auto_ai_router_credential_errors_total{credential}` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫

#### Health Check
- **Endpoint**: `/health` (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
- **–û—Ç–≤–µ—Ç**:
  - `200 OK` - –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω credential –¥–æ—Å—Ç—É–ø–µ–Ω
  - `503 Service Unavailable` - –µ—Å–ª–∏ –≤—Å–µ credentials –∑–∞–±–∞–Ω–µ–Ω—ã –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
- **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞**:
```json
{
  "status": "healthy",
  "credentials_available": 2,
  "credentials_banned": 1,
  "total_credentials": 3
}
```

### 7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**: info, debug, error
  - **info**: –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (credentials, server start, metrics)
  - **debug**: –î–µ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤—ã–±–æ—Ä credential, –º–æ–¥–µ–ª—å, streaming)
  - **error**: –û—à–∏–±–∫–∏ (upstream failures, credential unavailable)
- **–§–æ—Ä–º–∞—Ç**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `log/slog`
- **–í—ã–≤–æ–¥**: –í—Å–µ –ª–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ stdout
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞**: –ß–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `logging_level` –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ**:
  - INFO: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞–≥—Ä—É–∑–∫–∞ credentials, –º–µ—Ç—Ä–∏–∫–∏
  - DEBUG: –í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã (–º–µ—Ç–æ–¥, path, –≤—ã–±—Ä–∞–Ω–Ω—ã–π credential, –º–æ–¥–µ–ª—å)
  - ERROR: –û—à–∏–±–∫–∏ upstream, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å credentials, –æ—à–∏–±–∫–∏ streaming

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–¶–µ–ª–µ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: –°–æ—Ç–Ω–∏ —Ç—ã—Å—è—á –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- **–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ä—É—Ç–∏–Ω Go
- **Latency**: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ (<1ms overhead)
- **Memory**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (–±–µ–∑ —É—Ç–µ—á–µ–∫)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
```
auto_ai_router/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ server/
‚îÇ       ‚îî‚îÄ‚îÄ main.go              # Entry point
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.go            # –ü–∞—Ä—Å–∏–Ω–≥ YAML –∫–æ–Ω—Ñ–∏–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ router/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.go            # HTTP —Ä–æ—É—Ç–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ proxy/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ proxy.go             # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ balancer/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roundrobin.go        # Round-robin –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
‚îÇ   ‚îú‚îÄ‚îÄ ratelimit/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rpm.go               # RPM –∫–æ–Ω—Ç—Ä–æ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ fail2ban/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fail2ban.go          # Fail2ban –º–µ—Ö–∞–Ω–∏–∑–º
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/
‚îÇ       ‚îî‚îÄ‚îÄ metrics.go           # Prometheus –º–µ—Ç—Ä–∏–∫–∏
‚îú‚îÄ‚îÄ config.yaml                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ go.mod
‚îú‚îÄ‚îÄ go.sum
‚îî‚îÄ‚îÄ README.md
```

## –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
2. ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (YAML)
3. ‚úÖ HTTP —Ä–æ—É—Ç–µ—Ä —Å –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º `/v1/*`
4. ‚úÖ Round-robin –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ —Å RPM –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
5. ‚úÖ –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–¥–º–µ–Ω–æ–π —Ç–æ–∫–µ–Ω–æ–≤
6. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ streaming (SSE)
7. ‚úÖ Fail2ban –º–µ—Ö–∞–Ω–∏–∑–º
8. ‚úÖ Prometheus –º–µ—Ç—Ä–∏–∫–∏
9. ‚úÖ Health check endpoint
10. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–æ–¥–µ–ª–µ–π –∏ model-aware routing
11. üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

---

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã)

## –°—Ç–∞—Ç—É—Å: MVP —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω ‚úÖ

–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è.

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (internal/config/config.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –ü–∞—Ä—Å–∏–Ω–≥ YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ gopkg.in/yaml.v3
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ time.Duration –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ ban_duration
- –í–∞–ª–∏–¥–∞—Ü–∏—è URL –¥–ª—è base_url credentials
- –ö–∞—Å—Ç–æ–º–Ω—ã–π UnmarshalYAML –¥–ª—è Fail2BanConfig
- –°—Ç—Ä—É–∫—Ç—É—Ä—ã: Config, ServerConfig, Fail2BanConfig, CredentialConfig, MonitoringConfig

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `time.Duration` –¥–ª—è `request_timeout` –∏ `ban_duration`
- `ban_duration` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç "permanent" (–ø–∞—Ä—Å–∏—Ç—Å—è –∫–∞–∫ 0) –∏–ª–∏ duration (–Ω–∞–ø—Ä–∏–º–µ—Ä, "5m", "1h")
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
  - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–æ–≤ (1-65535)
  - –ù–∞–ª–∏—á–∏–µ credentials
  - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å RPM –ª–∏–º–∏—Ç–æ–≤
  - –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å base_url (http/https —Å—Ö–µ–º–∞, –Ω–∞–ª–∏—á–∏–µ host)
- –ö–∞—Å—Ç–æ–º–Ω—ã–π UnmarshalYAML –º–µ—Ç–æ–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ ban_duration
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `config.Load(path string)`

### 2. Fail2Ban (internal/fail2ban/fail2ban.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞–∑–±–∞–Ω–æ–º
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- Thread-safe —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å sync.RWMutex
- –°—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ credential
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω –ø–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –æ—à–∏–±–æ–∫
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ permanent, —Ç–∞–∫ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–∞–Ω –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
- –ú–µ—Ç–æ–¥ —Ä–∞–∑–±–∞–Ω–∞ (Unban) –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –°—Ç–∞—Ç—É—Å –∫–æ–¥–∞ 200 —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
- –¢–æ–ª—å–∫–æ –∫–æ–¥—ã –∏–∑ `error_codes` —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—à–∏–±–∫–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `banDuration`: 0 = permanent ban, >0 = –≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω
- –ú–µ—Ç–æ–¥ `IsBanned()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –±–∞–Ω–∞ –∏ —Ä–∞–∑–±–∞–Ω–∏–≤–∞–µ—Ç
- –•—Ä–∞–Ω–∏—Ç –≤—Ä–µ–º—è –±–∞–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ credential –≤ `banTime map[string]time.Time`
- –ú–µ—Ç–æ–¥—ã: `RecordResponse()`, `IsBanned()`, `GetFailureCount()`, `Unban()`, `GetBannedCredentials()`

### 3. Rate Limiter (internal/ratelimit/rpm.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- Sliding window –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ RPM
- Thread-safe —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –º—å—é—Ç–µ–∫—Å–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ limiter
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å—Ç–∞—Ä—à–µ 1 –º–∏–Ω—É—Ç—ã)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ credential-level –∏ model-level RPM

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- **Credential RPM**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
  - `AddCredential(name, rpm)` - —Å–æ–∑–¥–∞–µ—Ç limiter –¥–ª—è credential
  - `Allow(credentialName)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
  - `GetCurrentRPM(credentialName)` - —Ç–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

- **Model RPM**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥–µ–ª–∏
  - `AddModel(modelName, rpm)` - —Å–æ–∑–¥–∞–µ—Ç limiter –¥–ª—è –º–æ–¥–µ–ª–∏
  - `AllowModel(modelName)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –º–æ–¥–µ–ª–∏
  - `GetCurrentModelRPM(modelName)` - —Ç–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
  - `GetAllModels()` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π

- –•—Ä–∞–Ω–∏—Ç timestamp –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–ª–∞–π—Å–µ
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `limiter` –¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤

### 4. –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ (internal/balancer/roundrobin.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- Round-robin —Å —É—á—ë—Ç–æ–º fail2ban –∏ RPM –ª–∏–º–∏—Ç–æ–≤
- –ü—Ä–æ–ø—É—Å–∫ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö credentials
- –ü—Ä–æ–ø—É—Å–∫ credentials —Å –∏—Å—á–µ—Ä–ø–∞–Ω–Ω—ã–º RPM –ª–∏–º–∏—Ç–æ–º
- –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ –∫–æ–≥–¥–∞ –≤—Å–µ credentials –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –≤—Å–µ credentials –º–∞–∫—Å–∏–º—É–º 1 —Ä–∞–∑
- –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω credential –Ω–µ –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `ErrNoCredentialsAvailable`
- –ú–µ—Ç–æ–¥ `Next()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É Credential
- –ú–µ—Ç–æ–¥ `RecordResponse()` –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –≤ fail2ban
- –ú–µ—Ç–æ–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: `GetAvailableCount()`, `GetBannedCount()`, `GetCredentials()`

### 5. Proxy (internal/proxy/proxy.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ upstream API
- –ü–æ–¥–º–µ–Ω–∞ Authorization header
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ streaming (SSE) —Å flush –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ body —á–µ—Ä–µ–∑ LimitReader
- Health check endpoint
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ Prometheus
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ slog

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- **Master key verification**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Authorization header –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å master_key
- **Streaming detection**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Content-Type –Ω–∞ "text/event-stream" –∏ "application/stream+json"
- **Token substitution**: –∑–∞–º–µ–Ω—è–µ—Ç master_key –Ω–∞ credential API key
- **–¢–∞–π–º–∞—É—Ç—ã**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç http.Client —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º timeout
- **–†–∞–∑–º–µ—Ä body**: –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `MaxBodySizeMB * 1024 * 1024`
- **Streaming**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±—É—Ñ–µ—Ä 8192 –±–∞–π—Ç–∞, flush –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
- **–ú–µ—Ç—Ä–∏–∫–∏**: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç duration, status code, endpoint –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
  - DEBUG: –¥–µ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å–∞ (credential, model, path)
  - ERROR: –Ω–µ–≤–µ—Ä–Ω—ã–π master_key, –æ—à–∏–±–∫–∏ upstream
- –ö–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ headers –∫—Ä–æ–º–µ Authorization
- –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π URL: `baseURL + path + query`
- **–ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π**: –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 7 —Å–∏–º–≤–æ–ª–æ–≤

**Streaming —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```go
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Flusher –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –ß—Ç–µ–Ω–∏–µ —á–∞–Ω–∫–∞–º–∏ –ø–æ 8KB
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π flush –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ EOF –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ streaming —á–µ—Ä–µ–∑ slog
```

### 6. Router (internal/router/router.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –ü–µ—Ä–µ—Ö–≤–∞—Ç –≤—Å–µ—Ö `/v1/*` endpoints
- Health check endpoint
- 404 –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –†–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `http.Handler`
- Health check –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ credentials
- –ü—Ä–∏ unhealthy —Å—Ç–∞—Ç—É—Å–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 503
- –§–æ—Ä–º–∞—Ç health response:
```json
{
  "status": "healthy",
  "credentials_available": 2,
  "credentials_banned": 1,
  "total_credentials": 3
}
```

### 7. Monitoring (internal/monitoring/metrics.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- Prometheus –º–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ promauto (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
- 5 —Ç–∏–ø–æ–≤ –º–µ—Ç—Ä–∏–∫ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å proxy –¥–ª—è –∑–∞–ø–∏—Å–∏ –º–µ—Ç—Ä–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ RPM –∏ banned –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –ú–µ—Ç—Ä–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `promauto.New*`
- –ú–µ—Ç—Ä–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ default registry
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `Metrics` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –∑–∞–ø–∏—Å–∏ –º–µ—Ç—Ä–∏–∫
- –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º proxy –∑–∞–ø—Ä–æ—Å–µ
- Background goroutine –æ–±–Ω–æ–≤–ª—è–µ—Ç RPM –∏ ban —Å—Ç–∞—Ç—É—Å—ã

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**:
1. `auto_ai_router_requests_total` - Counter —Å labels: credential, endpoint, status
2. `auto_ai_router_requests_duration_seconds` - Histogram —Å labels: credential, endpoint
3. `auto_ai_router_credential_rpm_current` - Gauge —Å label: credential (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10s)
4. `auto_ai_router_credential_banned` - Gauge —Å label: credential (1=banned, 0=active, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10s)
5. `auto_ai_router_credential_errors_total` - Counter —Å label: credential

### 8. Logger (internal/logger/logger.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `log/slog`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 3 —É—Ä–æ–≤–Ω–µ–π: info, debug, error
- –¢–µ–∫—Å—Ç–æ–≤—ã–π –∏ JSON —Ñ–æ—Ä–º–∞—Ç—ã –≤—ã–≤–æ–¥–∞
- –í—Å–µ –ª–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ stdout

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
  - **info**: –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
  - **debug**: –î–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã (–∑–∞–ø—Ä–æ—Å—ã, streaming)
  - **error**: –û—à–∏–±–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–∞–∫–µ—Ç `log/slog` (Go 1.21+)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤–æ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
  - **INFO**: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞, credentials, –º–µ—Ç—Ä–∏–∫–∏, –º–æ–¥–µ–ª–∏
  - **DEBUG**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤, –≤—ã–±–æ—Ä credential, –º–æ–¥–µ–ª—å, streaming
  - **ERROR**: –û—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è body, upstream, streaming, fetching –º–æ–¥–µ–ª–µ–π

**–ú–µ—Ç–æ–¥—ã**:
- `New(level string)` - —Å–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π logger —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º
- `NewJSON(level string)` - —Å–æ–∑–¥–∞–µ—Ç JSON logger —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º
- `parseLevel(level string)` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ slog.Level

### 9. Model Manager (internal/models/manager.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–æ–¥–µ–ª–µ–π –æ—Ç –≤—Å–µ—Ö credentials –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `/v1/models` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ credential
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
- –ú–∞–ø–ø–∏–Ω–≥ –º–æ–¥–µ–ª—å ‚Üí —Å–ø–∏—Å–æ–∫ credentials
- –û–±—Ä–∞–±–æ—Ç–∫–∞ GET `/v1/models` —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
- Model-aware routing - –≤—ã–±–æ—Ä credentials –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –í–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ `replace_v1_models: true` –≤ –∫–æ–Ω—Ñ–∏–≥–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –¥–µ–ª–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –∫–∞–∂–¥–æ–º—É credential
- –•—Ä–∞–Ω–∏—Ç —Ç—Ä–∏ –º–∞–ø–ø–∏–Ω–≥–∞:
  - `credentialModels`: credential name ‚Üí —Å–ø–∏—Å–æ–∫ model IDs
  - `modelToCredentials`: model ID ‚Üí —Å–ø–∏—Å–æ–∫ credential names
  - `allModels`: –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
- –ï—Å–ª–∏ fetching –º–æ–¥–µ–ª–µ–π –Ω–µ —É–¥–∞–ª—Å—è –¥–ª—è –∫–∞–∫–æ–≥–æ-—Ç–æ credential, –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è warning
- Thread-safe —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º sync.RWMutex
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `ModelChecker`

**–ú–µ—Ç–æ–¥—ã**:
- `FetchModels()` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª–∏ –æ—Ç –≤—Å–µ—Ö credentials –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- `GetAllModels()` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
- `GetCredentialsForModel()` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ credentials –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö –º–æ–¥–µ–ª—å
- `HasModel()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ credential –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–æ–¥–µ–ª—å
- `IsEnabled()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∫–ª—é—á–µ–Ω –ª–∏ model-aware routing

### 10. Main Entry Point (cmd/server/main.go)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ `-config`
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Graceful shutdown –ø–æ SIGINT/SIGTERM —Å —Ç–∞–π–º–∞—É—Ç–æ–º 30 —Å–µ–∫—É–Ω–¥
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ slog
- Background –º–µ—Ç—Ä–∏–∫ updater

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏**:
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–∞–µ—Ç `config.yaml` –∏–∑ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `log/slog` –¥–ª—è –≤—Å–µ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- Prometheus metrics endpoint `/metrics` –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ `prometheus_enabled: true`
- Graceful shutdown —á–µ—Ä–µ–∑ `server.Shutdown(ctx)` —Å context –∏ timeout
- Background goroutine –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ RPM –∏ ban —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ slog.Error

**–ü–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**:
1. Config load & validation (—Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π `/v1` –∏–∑ base_url)
2. Logger –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö credentials
4. Fail2Ban (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π auto-unban)
5. RateLimiter
6. Balancer (—Å–≤—è–∑—ã–≤–∞–µ—Ç fail2ban + ratelimiter + credentials)
7. Model Manager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ fetching –º–æ–¥–µ–ª–µ–π (–µ—Å–ª–∏ `replace_v1_models: true`)
8. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ModelChecker –≤ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
9. Metrics
10. Proxy (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç balancer, logger, metrics)
11. Background metrics updater (–µ—Å–ª–∏ Prometheus –≤–∫–ª—é—á–µ–Ω)
12. Router (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç proxy –∏ model manager)
13. HTTP Server —Å –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–æ—Ä–æ–º
14. Graceful shutdown handler

## –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Go 1.23+ (–ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω –Ω–∞ Go 1.25.6)
- Linux/macOS/Windows

### –ö–æ–º–∞–Ω–¥—ã
```bash
# –°–±–æ—Ä–∫–∞
export PATH=/usr/local/go/bin:$PATH  # –µ—Å–ª–∏ Go —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ /usr/local/go
go build -o auto_ai_router ./cmd/server/

# –ó–∞–ø—É—Å–∫ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º
./auto_ai_router

# –ó–∞–ø—É—Å–∫ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º
./auto_ai_router -config /path/to/config.yaml

# –°–±–æ—Ä–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π —Ä–∞–∑–º–µ—Ä–∞
go build -ldflags="-s -w" -o auto_ai_router ./cmd/server/
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
```
auto_ai_router/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ server/
‚îÇ       ‚îî‚îÄ‚îÄ main.go              # ‚úÖ Entry point
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.go            # ‚úÖ YAML –ø–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models_config.go     # ‚úÖ models.yaml –ø–∞—Ä—Å–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ router/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.go            # ‚úÖ HTTP —Ä–æ—É—Ç–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ proxy/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ proxy.go             # ‚úÖ –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ + streaming
‚îÇ   ‚îú‚îÄ‚îÄ balancer/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roundrobin.go        # ‚úÖ Round-robin + RPM + fail2ban + model filtering
‚îÇ   ‚îú‚îÄ‚îÄ ratelimit/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rpm.go               # ‚úÖ Sliding window RPM limiter
‚îÇ   ‚îú‚îÄ‚îÄ fail2ban/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fail2ban.go          # ‚úÖ Fail2ban —Å –∞–≤—Ç–æ-—Ä–∞–∑–±–∞–Ω–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ monitoring/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ metrics.go           # ‚úÖ Prometheus –º–µ—Ç—Ä–∏–∫–∏ (–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã)
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ manager.go           # ‚úÖ Model manager –¥–ª—è –∞–≤—Ç–æ—Å–±–æ—Ä–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ logger/
‚îÇ       ‚îî‚îÄ‚îÄ logger.go            # ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (slog)
‚îú‚îÄ‚îÄ examples/                    # ‚úÖ Python –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ basic_request.py         # ‚úÖ –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
‚îÇ   ‚îú‚îÄ‚îÄ streaming_request.py    # ‚úÖ Streaming –∑–∞–ø—Ä–æ—Å
‚îÇ   ‚îú‚îÄ‚îÄ multiple_requests.py    # ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ test_health.py           # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ /health
‚îÇ   ‚îú‚îÄ‚îÄ test_metrics.py          # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ /metrics
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt         # ‚úÖ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ .env.example             # ‚úÖ –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ README.md                # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ config.yaml                  # ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ models.yaml                  # ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è RPM –¥–ª—è –º–æ–¥–µ–ª–µ–π (auto-generated)
‚îú‚îÄ‚îÄ models.yaml.example          # ‚úÖ –ü—Ä–∏–º–µ—Ä models.yaml
‚îú‚îÄ‚îÄ go.mod                       # ‚úÖ Go 1.23.0
‚îú‚îÄ‚îÄ go.sum                       # ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Makefile                     # ‚úÖ –ö–æ–º–∞–Ω–¥—ã —Å–±–æ—Ä–∫–∏
‚îî‚îÄ‚îÄ ISSUE.md                     # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (go.mod)
```
- gopkg.in/yaml.v3 v3.0.1                          # YAML parsing
- github.com/prometheus/client_golang v1.23.2     # Prometheus metrics
- github.com/prometheus/client_model v0.6.2
- github.com/prometheus/common v0.66.1
- github.com/prometheus/procfs v0.16.1
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å curl

#### Health Check
```bash
curl http://localhost:8080/health
```

Expected response:
```json
{
  "status": "healthy",
  "credentials_available": 2,
  "credentials_banned": 0,
  "total_credentials": 2
}
```

#### Prometheus Metrics
```bash
curl http://localhost:8080/metrics
```

#### Proxy Request (–ø—Ä–∏–º–µ—Ä –¥–ª—è OpenAI)
```bash
curl http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-your-master-key-here" \
  -d '{
    "model": "gpt-4o-mini",
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

**–í–∞–∂–Ω–æ**: `sk-your-master-key-here` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `server.master_key` –≤ `config.yaml`

### Python –ø—Ä–∏–º–µ—Ä—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ü–∞–ø–∫–∞ `examples/` —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–æ—Ç–æ–≤—ã–µ Python —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π —Ä–æ—É—Ç–µ—Ä–∞:

```bash
cd examples

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ master_key
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ —É–∫–∞–∂–∏—Ç–µ ROUTER_MASTER_KEY –∏–∑ config.yaml

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Ä–æ—É—Ç–µ—Ä–∞
python test_health.py

# –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ streaming
python basic_request.py

# Streaming –∑–∞–ø—Ä–æ—Å (SSE)
python streaming_request.py

# –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
python multiple_requests.py

# –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫ Prometheus
python test_metrics.py
```

**–í–∞–∂–Ω–æ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `ROUTER_MASTER_KEY` –≤ `.env` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `server.master_key` –≤ `config.yaml`

–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. `examples/README.md`

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ TODO

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –≤ proxy**: –ú–µ—Ç—Ä–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
2. ‚úÖ **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ RPM –º–µ—Ç—Ä–∏–∫**: Background goroutine –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
3. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `log/slog` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π debug —Ä–µ–∂–∏–º–∞
4. ‚úÖ **Graceful shutdown**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å context –∏ timeout 30 —Å–µ–∫—É–Ω–¥
5. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è base_url**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å URL —Å http/https —Å—Ö–µ–º–æ–π
6. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–∞–Ω**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ permanent, —Ç–∞–∫ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ban_duration`)
7. ‚úÖ **Makefile**: –î–æ–±–∞–≤–ª–µ–Ω –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å–±–æ—Ä–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º
8. ‚úÖ **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ `/v1` –∏–∑ base_url**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç `/v1` —Å—É—Ñ—Ñ–∏–∫—Å –∏–∑ base_url –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Ç–∏
9. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ credentials –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ**: –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö credentials —Å –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
10. ‚úÖ **Model-aware routing**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–æ–¥–µ–ª–µ–π –∏ —É–º–Ω—ã–π –≤—ã–±–æ—Ä credentials –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
11. ‚úÖ **GET /v1/models endpoint**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –æ—Ç –≤—Å–µ—Ö credentials
12. ‚úÖ **–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**: –ó–∞–º–µ–Ω–µ–Ω boolean debug –Ω–∞ logging_level —Å —Ç—Ä–µ–º—è —É—Ä–æ–≤–Ω—è–º–∏ (info/debug/error)
13. ‚úÖ **Master key –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π master_key –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–æ—É—Ç–µ—Ä—É
14. ‚úÖ **Model-level RPM**: –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤ (credential + model) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º models.yaml

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ TODO
1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ streaming**:
   - –ù—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º OpenAI streaming endpoint
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å flush
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ environment variables override –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (API keys)

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π fail2ban**:
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –±–∞–Ω–∞/—Ä–∞–∑–±–∞–Ω–∞ –≤ fail2ban –º–µ—Ö–∞–Ω–∏–∑–º

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–Ω–æ–≤–æ–µ)
1. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π**:
   - –°–µ–π—á–∞—Å –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å background job –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
   - –ü–æ–ª–µ–∑–Ω–æ –µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –¥–æ–±–∞–≤–ª—è—é—Ç –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞

2. **–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è model routing**:
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –º–æ–¥–µ–ª—è–º
   - `auto_ai_router_requests_by_model{model}` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
   - `auto_ai_router_model_rpm_current{model}` - —Ç–µ–∫—É—â–∏–π RPM –ø–æ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
   - `auto_ai_router_model_routing_errors_total` - –æ—à–∏–±–∫–∏ –∫–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
   - `auto_ai_router_model_rpm_exceeded_total{model}` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è model RPM

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. **–ü–æ–¥–º–µ–Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ JSON body**:
   - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∑–∞–ª–æ–∂–µ–Ω, –Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
   - –ú–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

2. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö API —Ç–∏–ø–æ–≤**:
   - –°–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Anthropic, Cohere –∏ –¥—Ä.

3. **Admin API**:
   - Endpoint –¥–ª—è —Ä–∞–∑–±–∞–Ω–∞ credentials
   - Endpoint –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - Endpoint –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

4. **–¢–µ—Å—Ç—ã**:
   - Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
   - Integration —Ç–µ—Å—Ç—ã
   - Benchmarks –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**:
   - –ü—É–ª –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è GC pressure
   - –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≥–æ—Ä—è—á–∏—Ö –ø—É—Ç–µ–π

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### Model-Aware Routing (–Ω–æ–≤–æ–µ)
–†–æ—É—Ç–µ—Ä —Ç–µ–ø–µ—Ä—å —É–º–µ–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å credentials –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π:

1. **–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ**:
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `/v1/models` —É –≤—Å–µ—Ö credentials
   - –°—Ç—Ä–æ–∏—Ç –º–∞–ø–ø–∏–Ω–≥ model ‚Üí credentials
   - –î–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –¥–ª—è –æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞

2. **–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞**:
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç `model` –∏–∑ JSON body –∑–∞–ø—Ä–æ—Å–∞
   - –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç credentials –ø–æ –Ω–∞–ª–∏—á–∏—é –º–æ–¥–µ–ª–∏
   - –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ —É –æ–¥–Ω–æ–≥–æ credential ‚Üí 503

3. **GET /v1/models**:
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
   - –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Å–æ –≤—Å–µ—Ö credentials
   - –†–æ—É—Ç–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ø—Ä–∞–≤–∏—Ç –∑–∞–ø—Ä–æ—Å –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É credential

4. **Fallback**:
   - –ï—Å–ª–∏ `replace_v1_models: false` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
   - –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π round-robin
   - –ï—Å–ª–∏ fetching –º–æ–¥–µ–ª–µ–π –Ω–µ —É–¥–∞–ª—Å—è - credential –æ—Å—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º

### Thread Safety
–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã thread-safe:
- **fail2ban**: sync.RWMutex –¥–ª—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **ratelimit**: –æ—Ç–¥–µ–ª—å–Ω—ã–π mutex –¥–ª—è –∫–∞–∂–¥–æ–≥–æ credential limiter
- **balancer**: mutex –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ current index
- **model manager**: sync.RWMutex –¥–ª—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –º–∞–ø–ø–∏–Ω–≥–æ–≤ –º–æ–¥–µ–ª–µ–π

### Memory Management
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `io.LimitReader` –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ request body
- Streaming –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –≤—Å–µ–≥–æ response –≤ –ø–∞–º—è—Ç—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö timestamps –≤ rate limiter

### Error Handling
- –ü—Ä–æ–∫–∏–¥—ã–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ `fmt.Errorf` —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- HTTP 503 –∫–æ–≥–¥–∞ –≤—Å–µ credentials –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
- HTTP 502 –ø—Ä–∏ –æ—à–∏–±–∫–µ upstream –∑–∞–ø—Ä–æ—Å–∞

### Performance Considerations
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ì–æ—Ä—É—Ç–∏–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π http.Server)
- Lock-free —á—Ç–µ–Ω–∏–µ –¥–ª—è IsBanned (RWMutex)

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Makefile

–ü—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç Makefile –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
make build        # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
make build-opt    # –°–±–æ—Ä–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π —Ä–∞–∑–º–µ—Ä–∞
make run          # –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
make clean        # –û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
make test         # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
make fmt          # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
make vet          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ go vet
make mod-tidy     # –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–∞–Ω
–ü–∞—Ä–∞–º–µ—Ç—Ä `ban_duration` —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ permanent –±–∞–Ω, —Ç–∞–∫ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–π:

```yaml
fail2ban:
  max_attempts: 3
  ban_duration: permanent  # –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω
  # –∏–ª–∏
  ban_duration: 5m        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–∞–Ω —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
  # –∏–ª–∏
  ban_duration: 1h        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–∞–Ω —á–µ—Ä–µ–∑ 1 —á–∞—Å
  error_codes: [401, 403, 429, 500, 502, 503, 504]
```

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–ü–∞—Ä–∞–º–µ—Ç—Ä `logging_level` —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –ª–æ–≥–æ–≤:

```yaml
server:
  logging_level: info   # –¢–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–∑–∞–ø—É—Å–∫, credentials, –æ—à–∏–±–∫–∏)
  # –∏–ª–∏
  logging_level: debug  # –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∫–ª—é—á–∞—è –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
  # –∏–ª–∏
  logging_level: error  # –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: `debug` - –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π —Ä–∞–±–æ—Ç—ã
- **Production**: `info` - –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–≥–æ —à—É–º–∞
- **Production —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏**: `error` - —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

### Model-level RPM
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥–µ–ª–µ–π —á–µ—Ä–µ–∑ `models.yaml`:

```yaml
# models.yaml (auto-generated)
models:
  - name: gpt-4o
    rpm: 50  # –ù–∏–∑–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è –¥–æ—Ä–æ–≥–æ–π –º–æ–¥–µ–ª–∏

  - name: gpt-4o-mini
    rpm: 100  # –°—Ä–µ–¥–Ω–∏–π –ª–∏–º–∏—Ç

  - name: gpt-3.5-turbo
    rpm: 150  # –í—ã—Å–æ–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –º–æ–¥–µ–ª–∏
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
1. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Ä–æ—É—Ç–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç `models.yaml` (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
2. Fetching –º–æ–¥–µ–ª–µ–π –æ—Ç credentials
3. –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `models.yaml` —Å `default_models_rpm`
4. –ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å RPM –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ—É—Ç–µ—Ä
5. –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è **–∏ credential RPM, –∏ model RPM**

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
- Credential RPM = 120
- Model "gpt-4o" RPM = 50
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ú–∞–∫—Å–∏–º—É–º 50 req/min –¥–ª—è gpt-4o —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç credential (–º–µ–Ω—å—à–∏–π –ª–∏–º–∏—Ç –ø–æ–±–µ–∂–¥–∞–µ—Ç)

### Master Key
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–æ—É—Ç–µ—Ä—É:

```yaml
server:
  master_key: "sk-your-secret-master-key"
```

**–í–∞–∂–Ω–æ**:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
- –ù–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ master_key –≤ git (–¥–æ–±–∞–≤—å—Ç–µ config.yaml –≤ .gitignore –¥–ª—è production)
- –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á –≤ `Authorization: Bearer <master_key>`
- –†–æ—É—Ç–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω–∏—Ç –µ–≥–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API –∫–ª—é—á –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```python
from openai import OpenAI

client = OpenAI(
    api_key="sk-your-secret-master-key",  # –ò–∑ config.yaml
    base_url="http://localhost:8080/v1"
)
```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Å—Ä–µ–¥–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ TODO –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `log/slog`
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω graceful shutdown —Å —Ç–∞–π–º–∞—É—Ç–æ–º 30 —Å–µ–∫—É–Ω–¥
- Fail2ban —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–∞–Ω —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –≤—Ä–µ–º—è